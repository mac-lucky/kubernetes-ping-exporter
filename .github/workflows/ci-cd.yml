---
name: CI/CD Pipeline - Kubernetes Ping Exporter

on:
  push:
    branches: ["master"]
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches: ["master"]
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".gitignore"
  pull_request_target:
    branches: ["master"]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".gitignore"
  release:
    types: [published]
  workflow_dispatch:

jobs:
  ci-cd:
    uses: mac-lucky/actions-shared-workflows/.github/workflows/go-cicd-reusable.yml@master
    permissions:
      contents: read
      packages: write
      security-events: write
    with:
      # Required parameters
      app_name: "kubernetes-ping-exporter"
      dockerhub_image: "maclucky/kubernetes-ping-exporter"
      ghcr_image: "ghcr.io/mac-lucky/kubernetes-ping-exporter"

      # Build configuration
      dockerfile_path: "./Dockerfile"
      build_context: "."

      # Test configuration
      enable_container_tests: false
      enable_kubernetes_tests: true
      helm_chart_path: "./infra-ping-exporter"
      helm_release_name: "ping-exporter"
      app_label_selector: "ping-exporter"
      enable_custom_metrics_test: true
      metrics_port: "9107"
      metrics_test_pattern: "ping_loss_ratio"

      # Security and quality
      enable_security_scan: true
      enable_sbom: true

      # Deployment
      enable_auto_version: true
      push_on_main: true
    secrets:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}